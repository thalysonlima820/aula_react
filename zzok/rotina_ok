
--SEPARADOR
   SELECT * FROM (
SELECT * 
  FROM (
WITH ERROS 
  AS (
       SELECT E.MATERRO MATRICULA
           , COUNT(DISTINCT E.NUMOS) QT_OS_COM_ERRO
           , SUM(NVL(E.QT,0)) QT_DE_ERRO
        FROM PCWMSERRO E
           , PCEMPR EM
       WHERE  E.MATERRO = EM.MATRICULA
       AND E.NUMOS IN (SELECT M.NUMOS FROM PCMOVENDPEND M WHERE M.DTINICIOOS BETWEEN to_date(:DTINICIO) AND to_date(:DTFIM) AND M.DTINICIOOS IS NOT NULL AND M.CODOPER NOT IN ('SA','EA')
       AND M.DTFIMSEPARACAO IS NOT NULL AND M.CODFUNCOS = EM.MATRICULA AND M.POSICAO = 'C' AND M.NUMOS IS NOT NULL)
       AND E.MATERRO = EM.MATRICULA
       group
          BY E.MATERRO   
      )
      
   , PRODUTIVIDADE
   AS (SELECT TAB.MATRICULA
           , WMS_FORMATATEMPODIA(SUM(TAB.TEMPO)) AS TEMPO
        FROM (select (MAX(dtfimseparacao)- MIN(dtinicioos)) tempo
                   , NUMOS
                   , CODFUNCOS MATRICULA
                from pcmovendpend
               where DTINICIOOS BETWEEN to_date(:DTINICIO) AND to_date(:DTFIM)
                 AND CODFUNCOS IS NOT NULL
               GROUP 
                  BY NUMOS
                   , CODFUNCOS
             ) TAB
       GROUP
          BY TAB.MATRICULA
       )       
      
SELECT 
      
       PCEMPR.MATRICULA,   
       PCEMPR.NOME,  
       'SEPARADOR' FUNCAO,
       COUNT(DISTINCT PCMOVENDPEND.NUMOS)  QUANT_OS,
       SUM(PCMOVENDPEND.QT) QUANT_ITENS,
       COUNT(DISTINCT TO_CHAR(PCMOVENDPEND.NUMOS,'FM0000000000') || TO_CHAR(PCMOVENDPEND.CODENDERECO,'FM0000000000')||PCMOVENDPEND.TIPOOS) QUANT_APANHAS,
       0 PESO_TOTAL,                         
      (SELECT MAX(TEMPO) FROM PRODUTIVIDADE WHERE MATRICULA = PCEMPR.MATRICULA)  TEMPO,
       PCPERFILUSUARIOWMS.DESCRICAOPERFIL AS DESC_PERFIL                

  FROM PCPRODUT,
       PCMOVENDPEND, 
       PCEMPR,
       PCPERFILUSUARIOWMS--,

 WHERE PCPRODUT.CODPROD = PCMOVENDPEND.CODPROD
   AND PCEMPR.MATRICULA = PCMOVENDPEND.CODFUNCOS
   AND PCEMPR.CODIGOPERFIL = PCPERFILUSUARIOWMS.CODIGOPERFIL  
   AND PCMOVENDPEND.CODFILIAL = '1' 
   AND PCMOVENDPEND.DTFIMSEPARACAO IS NOT NULL
   AND PCMOVENDPEND.DTINICIOOS IS NOT NULL
   AND PCMOVENDPEND.CODOPER NOT IN ('SA','EA')
   and PCMOVENDPEND.DTINICIOOS >= to_date(:DTINICIO)
   and PCMOVENDPEND.DTINICIOOS <= to_date(:DTFIM)
   AND PCMOVENDPEND.NUMOS IS NOT NULL
   AND PCMOVENDPEND.POSICAO = 'C'
   AND PCMOVENDPEND.DTFIMOS IS NOT NULL
   AND PCMOVENDPEND.DTESTORNO IS NULL
   AND PCMOVENDPEND.CODFUNCOS IS NOT NULL 
   AND PCMOVENDPEND.CODFUNCOS IN (
      82, 250, 239, 11, 167, 238, 196, 83, 67, 187, 228, 243, 146, 205, 260, 197,
      202, 195, 244, 60, 224, 108, 1, 227, 213, 229, 52, 87, 189, 201, 186, 243

   )   
 GROUP BY 
       PCPERFILUSUARIOWMS.DESCRICAOPERFIL,                
       PCMOVENDPEND.CODFUNCOS,
       PCEMPR.NOME,
       PCEMPR.MATRICULA
)

--CONFERENTE

UNION ALL
SELECT *
  FROM (
WITH ERROS 
  AS ( SELECT E.MATERRO MATRICULA
           , COUNT(DISTINCT E.NUMOS) QT_OS_COM_ERRO
           , SUM(NVL(E.QT,0)) QT_DE_ERRO
        FROM PCWMSERRO E
           , PCEMPR EM
       WHERE  E.MATERRO = EM.MATRICULA
       AND E.NUMOS IN (SELECT M.NUMOS 
                         FROM PCMOVENDPEND M 
                        WHERE M.DTINICIOOS BETWEEN to_date(:DTINICIO) AND to_date(:DTFIM) 
                          AND M.DTINICIOOS IS NOT NULL 
                          AND M.CODOPER NOT IN ('SA','EA')
                          AND M.DTFIMSEPARACAO IS NOT NULL 
                          AND NVL(M.CODFUNCCOFERENTE,M.CODFUNCCONF)  = EM.MATRICULA 
                          AND M.POSICAO = 'C'
                          AND M.NUMOS IS NOT NULL)
       group
          BY E.MATERRO    
      )
   , PRODUTIVIDADE
   AS (SELECT TAB.MATRICULA
           , WMS_FORMATATEMPODIA(SUM(TAB.TEMPO)) AS TEMPO
        FROM (select (MAX(PCMOVENDPEND.dtfimconferencia)- MIN(PCMOVENDPEND.dtinicioconferencia)) tempo
                   , PCMOVENDPEND.NUMOS
                   , NVL(PCMOVENDPEND.CODFUNCCOFERENTE, PCMOVENDPEND.CODFUNCCONF) MATRICULA
                from pcmovendpend
               where PCMOVENDPEND.DTINICIOOS BETWEEN to_date(:DTINICIO) AND to_date(:DTFIM)
                 AND (PCMOVENDPEND.CODFUNCCOFERENTE IS NOT NULL OR PCMOVENDPEND.CODFUNCCONF IS NOT NULL ) 
               GROUP 
                  BY PCMOVENDPEND.NUMOS
                   , NVL(PCMOVENDPEND.CODFUNCCOFERENTE, PCMOVENDPEND.CODFUNCCONF)
             ) TAB
       GROUP
          BY TAB.MATRICULA
       )       
             
SELECT 
      
      PCEMPR.MATRICULA,   
      PCEMPR.NOME,    
      'CONFERENTE' FUNCAO,  
      COUNT(DISTINCT PCMOVENDPEND.NUMOS)  QUANT_OS,
      SUM(PCMOVENDPEND.QT) QUANT_ITENS,
      0 QUANT_APANHAS,
      SUM(PCMOVENDPEND.QT * PCPRODUT.PESOBRUTO)  PESO_TOTAL,
      (SELECT MAX(TEMPO) FROM PRODUTIVIDADE WHERE MATRICULA = PCEMPR.MATRICULA)  TEMPO,
      PCPERFILUSUARIOWMS.DESCRICAOPERFIL AS DESC_PERFIL  
      
  FROM PCPRODUT,
       PCMOVENDPEND, 
       PCEMPR,
       PCPERFILUSUARIOWMS--,
   
 WHERE PCPRODUT.CODPROD = PCMOVENDPEND.CODPROD
   AND PCEMPR.MATRICULA = NVL(PCMOVENDPEND.CODFUNCCOFERENTE,PCMOVENDPEND.CODFUNCCONF )
   AND PCEMPR.CODIGOPERFIL = PCPERFILUSUARIOWMS.CODIGOPERFIL  
   AND PCMOVENDPEND.CODFILIAL = '1' 
   AND PCMOVENDPEND.DTFIMSEPARACAO IS NOT NULL
   AND PCMOVENDPEND.DTFIMCONFERENCIA IS NOT NULL
   AND PCMOVENDPEND.DTINICIOCONFERENCIA IS NOT NULL
   AND PCMOVENDPEND.CODOPER NOT IN ('SA','EA')
   and PCMOVENDPEND.DTINICIOCONFERENCIA >= to_date(:DTINICIO)
   and PCMOVENDPEND.DTINICIOCONFERENCIA <= to_date(:DTFIM)
   AND PCMOVENDPEND.NUMOS IS NOT NULL
   AND PCMOVENDPEND.POSICAO = 'C'
   AND PCMOVENDPEND.DTFIMOS IS NOT NULL
   AND PCMOVENDPEND.DTESTORNO IS NULL
   AND (PCMOVENDPEND.CODFUNCCOFERENTE IS NOT NULL OR PCMOVENDPEND.CODFUNCCONF IS NOT NULL ) 
   AND NVL(PCMOVENDPEND.CODFUNCCOFERENTE ,PCMOVENDPEND.CODFUNCCONF )  IN (
      82, 239, 11, 167, 238, 67, 146, 197, 202, 108, 52, 189, 88, 186

   )
 GROUP BY  
       PCPERFILUSUARIOWMS.DESCRICAOPERFIL,                
       PCMOVENDPEND.CODFUNCCOFERENTE, 
       PCMOVENDPEND.CODFUNCCONF,
       PCEMPR.NOME,
       PCEMPR.MATRICULA
) 

--EMBALADOR 

UNION ALL
SELECT *
  FROM (
WITH ERROS 
  AS (SELECT E.MATERRO MATRICULA
           , COUNT(DISTINCT E.NUMOS) QT_OS_COM_ERRO
           , SUM(NVL(E.QT,0)) QT_DE_ERRO
        FROM PCWMSERRO E
           , PCEMPR EM
       WHERE  E.MATERRO = EM.MATRICULA
       AND E.NUMOS IN (SELECT M.NUMOS FROM PCMOVENDPEND M WHERE M.DTINICIOOS BETWEEN to_date(:DTINICIO) AND to_date(:DTFIM) AND M.DTINICIOOS IS NOT NULL AND M.CODOPER NOT IN ('SA','EA')
       AND M.DTFIMSEPARACAO IS NOT NULL AND M.CODFUNCEMBALADOR = EM.MATRICULA AND M.POSICAO = 'C' AND M.NUMOS IS NOT NULL)
       AND E.MATERRO = EM.MATRICULA
       group
          BY E.MATERRO    
      )
   , PRODUTIVIDADE
   AS (SELECT TAB.MATRICULA
           , WMS_FORMATATEMPODIA(SUM(TAB.TEMPO)) AS TEMPO
        FROM (select (MAX(dtfimconferencia)- MIN(dtinicioconferencia)) tempo
                   , NUMOS
                   , CODFUNCEMBALADOR MATRICULA
                from pcmovendpend
               where DTINICIOOS BETWEEN to_date(:DTINICIO) AND to_date(:DTFIM)
                 AND CODFUNCEMBALADOR IS NOT NULL
               GROUP 
                  BY NUMOS
                   , CODFUNCEMBALADOR
             ) TAB
       GROUP
          BY TAB.MATRICULA
       )       

SELECT 
       PCEMPR.MATRICULA,   
       PCEMPR.NOME,  
       'EMBALADOR' FUNCAO,
       COUNT(DISTINCT PCMOVENDPEND.NUMOS)  QUANT_OS,
       SUM(PCMOVENDPEND.QT) QUANT_ITENS,
       COUNT(DISTINCT TO_CHAR(PCMOVENDPEND.NUMOS,'FM0000000000') || TO_CHAR(PCMOVENDPEND.CODENDERECO,'FM0000000000')||PCMOVENDPEND.TIPOOS) QUANT_APANHAS,
       0 PESO_TOTAL,                         
      (SELECT MAX(TEMPO) FROM PRODUTIVIDADE WHERE MATRICULA = PCEMPR.MATRICULA)  TEMPO,
       PCPERFILUSUARIOWMS.DESCRICAOPERFIL AS DESC_PERFIL 
                                
  FROM PCPRODUT,
       PCMOVENDPEND, 
       PCEMPR,
       PCPERFILUSUARIOWMS--,

 WHERE PCPRODUT.CODPROD = PCMOVENDPEND.CODPROD
   AND PCEMPR.MATRICULA = PCMOVENDPEND.CODFUNCEMBALADOR
   AND PCEMPR.CODIGOPERFIL = PCPERFILUSUARIOWMS.CODIGOPERFIL  
   AND PCMOVENDPEND.CODFILIAL = '1' 
   AND PCMOVENDPEND.DTFIMSEPARACAO IS NOT NULL
   AND PCMOVENDPEND.DTFIMCONFERENCIA IS NOT NULL
   AND PCMOVENDPEND.CODOPER NOT IN ('SA','EA')
   and PCMOVENDPEND.DTFIMCONFERENCIA >= to_date(:DTINICIO)
   and PCMOVENDPEND.DTFIMCONFERENCIA <= to_date(:DTFIM)
   AND PCMOVENDPEND.NUMOS IS NOT NULL
   AND PCMOVENDPEND.POSICAO = 'C'
   AND PCMOVENDPEND.DTFIMOS IS NOT NULL
   AND PCMOVENDPEND.DTESTORNO IS NULL
   AND PCMOVENDPEND.CODFUNCEMBALADOR IS NOT NULL 
   AND PCMOVENDPEND.CODFUNCEMBALADOR IN (
      239, 238, 67, 202, 108, 52, 186

   ) 
 GROUP BY 
       PCPERFILUSUARIOWMS.DESCRICAOPERFIL,                
       PCMOVENDPEND.CODFUNCEMBALADOR,
       PCEMPR.NOME,
       PCEMPR.MATRICULA
)

) 
WHERE 1=1
AND FUNCAO IN (:FUN)
AND MATRICULA IN (:MATRICULA)
AND DESC_PERFIL IN (:PERFIL)
ORDER BY QUANT_APANHAS DESC, PESO_TOTAL DESC, QUANT_ITENS DESC